<%- include('../partials/user/header.ejs') %>
    <style>
        body {
            background-color: #ffe2f2;
            min-height: 100vh;
            padding: 2rem 0;
        }

        .order-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .progress-tracker {
            position: relative;
            margin: 30px 0;
        }

        .progress-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #f3ebeb;
            transform: translateY(-50%);
        }

        .progress-steps {
            position: relative;
            display: flex;
            justify-content: space-between;
        }

        .step {
            position: relative;
            width: 25px;
            height: 25px;
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 50%;
            z-index: 1;
        }

        .step.placed {
            background-color: rgb(158, 230, 95);
        }

        .step.packaging {
            background-color: rgb(225, 180, 0);
            color: white;
        }

        .step.ontheRoad {
            background-color: rgb(60, 90, 237);
        }

        .step.orderDelivered {
            background-color: green;
            color: white;
        }

        .step.active {
            border-color: #28a745;
            background: #8fd8a0;
        }

        .step.cancelled {
            border-color: #dc3545;
            background: #dc3545;
        }

        .step-label {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            color: #5d0451;
        }

        .activity-feed {
            margin: 2rem 0;
        }

        .activity-item {
            display: flex;
            align-items: start;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .activity-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-right: 15px;
        }

        .activity-icon.text-danger {
            background-color: rgba(220, 53, 69, 0.1);
        }

        .order-items {
            margin: 2rem 0;
        }

        .item-row {
            display: flex;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #dee2e6;
        }

        .item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            margin-right: 1rem;
            border-radius: 8px;
        }

        .address-card {
            padding: 1.5rem;
            border-radius: 12px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(79, 10, 39, 0.1);
            border: 1px solid rgba(79, 10, 39, 0.1);
        }

        .address-type {
            display: inline-block;
            padding: 4px 12px;
            background-color: #5d0451;
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }

        .address-details {
            color: #5d0451;
            line-height: 1.6;
        }

        .address-details .name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .address-details .location {
            margin-bottom: 1rem;
        }

        .address-details .contact {
            padding-top: 0.5rem;
            border-top: 1px dashed rgba(79, 10, 39, 0.2);
            font-size: 0.9rem;
        }

        .icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            opacity: 0.7;
        }

        .container.position-relative {
            padding: 0 50px;
        }

        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .nav-arrow:hover {
            background: #f8f9fa;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .nav-arrow:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-arrow-left {
            left: 10px;
        }

        .nav-arrow-right {
            right: 10px;
        }

        .order-card {
            transition: opacity 0.3s ease;
            margin: 0 auto;
            max-width: 900px;
            opacity: 1;
        }

        #ordersContainer {
            position: relative;
            min-height: 200px;
        }

        .order-card {
            transition: opacity 0.3s ease;
            margin: 0 auto;
            max-width: 900px;
            opacity: 0;
            display: none;
        }

        .order-card.active {
            display: block;
            opacity: 1;
        }

        .order-card.inactive {
            display: none;
            opacity: 0;
        }

        .status-label {
            display: block;
            color: red;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }
        .status-icon {
            display: block;
            margin: 0 auto 8px;
            color: #666; /* Default color for inactive icons */
        }

        .step.placed .status-icon,
        .step.packaging .status-icon,
        .step.ontheRoad .status-icon,
        .step.orderDelivered .status-icon {
            color: #4CAF50; /* Color for active icons */
        }

        .step.cancelled .status-icon {
            color: #f44336; /* Color for cancelled status */
        }
    </style>


    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/" rel="nofollow">Home</a>
                    <span></span> Pages
                    <span></span> Account
                </div>
            </div>
        </div>
        <section class="pt-150 pb-150">
            <div class="container">
                <div class="row">
                    <div class="col-lg-10 m-auto">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="dashboard-menu">
                                    <ul class="nav flex-column" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab"
                                                href="#dashboard" role="tab" aria-controls="dashboard"
                                                aria-selected="false"><i
                                                    class="fi-rs-settings-sliders mr-10"></i>Dashboard</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders"
                                                role="tab" aria-controls="orders" aria-selected="false"><i
                                                    class="fi-rs-shopping-bag mr-10"></i>Orders</a>
                                        </li>
                                        
                                        <li class="nav-item">
                                            <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address"
                                                role="tab" aria-controls="address" aria-selected="true"><i
                                                    class="fi-rs-marker mr-10"></i>My Address</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="account-detail-tab" data-bs-toggle="tab"
                                                href="#account-detail" role="tab" aria-controls="account-detail"
                                                aria-selected="true"><i class="fi-rs-user mr-10"></i>Account details</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="logOut"><i
                                                    class="fi-rs-sign-out mr-10"></i>Logout</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="tab-content dashboard-content">
                                    <div class="tab-pane fade active show" id="dashboard" role="tabpanel"
                                        aria-labelledby="dashboard-tab">
                                        <div class="container mt-5 p-4 border rounded shadow-sm bg-light"
                                            style="max-width: 400px;">
                                            <div class="row mb-3">
                                                <label class="col-sm-4 fw-bold">User Name:</label>
                                                <div class="col-sm-8">
                                                    <%= user.name %>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <label class="col-sm-4 fw-bold">Phone:</label>
                                                <div class="col-sm-8">
                                                    <%= user.phone %>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <label class="col-sm-4 fw-bold">Email:</label>
                                                <div class="col-sm-8">
                                                    <%= user.email %>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-around mt-4">
                                               
                                                <a href="/change-password" class="btn btn-secondary btn-sm">Change
                                                    Password</a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade " id="orders" role="tabpanel"
                                        aria-labelledby="orders-tab">
                                        <div class="container position-relative">
                                            <% if(userOrders && userOrders.length> 0) { %>
                                                <!-- Side Navigation Arrows -->
                                                <button class="nav-arrow nav-arrow-left"
                                                    onclick="navigateOrders('prev')" id="prevBtn">
                                                    <i class="fa fa-chevron-left" aria-hidden="true"></i>
                                                </button>
                                                <button class="nav-arrow nav-arrow-right"
                                                    onclick="navigateOrders('next')" id="nextBtn">
                                                    <i class="fa fa-chevron-right" aria-hidden="true"></i>
                                                </button>

                                                <!-- Orders container -->
                                                <div id="ordersContainer">
                                                    <% userOrders.forEach((order, index)=> { %>
                                                        <div class="order-card <%= index === 0 ? 'active' : 'inactive' %>"
                                                            data-order-index="<%= index %>">
                                                            <div
                                                                class="d-flex justify-content-between align-items-start">
                                                                <div>
                                                                    <h5 class="mb-1" id="orderId">
                                                                        <%= order.orderId %>
                                                                    </h5>
                                                                    <p class="text-muted small">
                                                                        <%= order.orderedItems.length %> Items â€¢ Order Placed on <%= order.createdOn.toLocaleDateString() %>
                                                                    </p>
                                                                    <p class="text-muted small">
                                                                        ðŸ’µ Payment Method : <%= order.paymentDetails.method %>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                            <!-- Progress Tracker -->
                                                            <div class="progress-tracker">
                                                                <div class="progress-line"></div>
                                                                <div class="progress-steps">
                                                                    <% if (order.status === 'Cancelled') { %>
                                                                        <div class="step active">
                                                                            <svg class="status-icon" width="30" height="30">
                                                                                <use href="#icon-order-placed"/>
                                                                            </svg>
                                                                            <span class="step-label text-success">Order Placed</span>
                                                                        </div>
                                                                        <div class="step active cancelled">
                                                                            <span class="step-label text-danger">Cancelled</span>
                                                                        </div>
                                                                    <% } else { %>
                                                                        <div class="step <%= order.status === 'Pending' || order.status === 'Processing' || order.status === 'Shipped' || order.status === 'Delivered' ? 'placed' : '' %>">
                                                                            <svg class="status-icon" width="30" height="30">
                                                                                <use href="#icon-order-placed"/>
                                                                            </svg>
                                                                            <span class="step-label">Order Placed</span>
                                                                        </div>
                                                                        <div class="step <%= order.status === 'Processing' || order.status === 'Shipped' || order.status === 'Delivered' ? 'packaging' : '' %>">
                                                                            <svg class="status-icon" width="30" height="30">
                                                                                <use href="#icon-packaging"/>
                                                                            </svg>
                                                                            <span class="step-label">Packaging</span>
                                                                        </div>
                                                                        <div class="step <%= order.status === 'Shipped' || order.status === 'Delivered' ? 'ontheRoad' : '' %>">
                                                                            <svg class="status-icon" width="30" height="30">
                                                                                <use href="#icon-on-road"/>
                                                                            </svg>
                                                                            <span class="step-label">On The Road</span>
                                                                        </div>
                                                                        <div class="step <%= order.status === 'Delivered' ? 'orderDelivered' : '' %>">
                                                                            <svg class="status-icon" width="30" height="30">
                                                                                <use href="#icon-delivered"/>
                                                                            </svg>
                                                                            <span class="step-label">Delivered</span>
                                                                        </div>
                                                                    <% } %>
                                                                </div>
                                                            </div>
                                                            <!-- Activity Feed -->
                                                            <div class="activity-feed">
                                                                <h6 class="mb-3">Order Activity</h6>
                                                            
                                                                <% if (order.status === 'Delivered') { %>
                                                                    <div class="activity-item bg-light">
                                                                        <div class="activity-icon text-success">âœ“</div>
                                                                        <div>
                                                                            <p class="mb-0">Your order has been delivered. Thank you for shopping!</p>
                                                                            <small class="text-muted">
                                                                                <%= new Date(order.invoiceDate).toLocaleString() %>
                                                                            </small>
                                                                        </div>
                                                                    </div>
                                                                <% } else if (order.status === 'Cancelled') { %>
                                                                    <div class="activity-item bg-light">
                                                                        <div class="activity-icon text-danger">âœ•</div>
                                                                        <div>
                                                                            <p class="mb-0">Your order has been cancelled.</p>
                                                                            <small class="text-muted">
                                                                                <%= new Date(order.cancelledOn).toLocaleString() %>
                                                                            </small>
                                                                        </div>
                                                                    </div>
                                                                <% } %>
                                                            
                                                                <% order.orderedItems.forEach(item => { %>
                                                                    <% if (item.returnDetails.status !== 'Not Requested') { %>
                                                                        <div class="activity-item bg-light">
                                                                            <div class="activity-icon 
                                                                                <% if (item.returnDetails.status === 'Return Requested') { %> text-warning <% } %>
                                                                                <% if (item.returnDetails.status === 'Approved') { %> text-primary <% } %>
                                                                                <% if (item.returnDetails.status === 'Returned') { %> text-success <% } %>
                                                                                <% if (item.returnDetails.status === 'Refunded') { %> text-info <% } %>
                                                                            ">
                                                                                <!-- Use appropriate symbols for each status -->
                                                                                <% if (item.returnDetails.status === 'Return Requested') { %> âŒ› <% } %>
                                                                                <% if (item.returnDetails.status === 'Approved') { %> âœ” <% } %>
                                                                                <% if (item.returnDetails.status === 'Returned') { %> â†© <% } %>
                                                                                <% if (item.returnDetails.status === 'Refunded') { %> ðŸ’µ <% } %>
                                                                            </div>
                                                                            <div>
                                                                                <p class="mb-0">
                                                                                    <% if (item.returnDetails.status === 'Return Requested') { %>
                                                                                        Return requested for <strong><%= item.product.productName %></strong>.
                                                                                    <% } else if (item.returnDetails.status === 'Approved') { %>
                                                                                        Return approved for <strong><%= item.product.productName %></strong>.
                                                                                    <% } else if (item.returnDetails.status === 'Returned') { %>
                                                                                        Item <strong><%= item.product.productName %></strong> has been returned.
                                                                                    <% } else if (item.returnDetails.status === 'Refunded') { %>
                                                                                        Refund processed for <strong><%= item.product.productName %></strong>.
                                                                                    <% } %>
                                                                                </p>
                                                                                <small class="text-muted">
                                                                                    <% if (item.returnDetails.status === 'Return Requested') { %>
                                                                                        <%= new Date(item.returnDetails.returnRequestedOn).toLocaleString() %>
                                                                                    <% } else if (item.returnDetails.status === 'Returned') { %>
                                                                                        <%= new Date(item.returnDetails.returnedOn).toLocaleString() %>
                                                                                    <% } %>
                                                                                </small>
                                                                            </div>
                                                                        </div>
                                                                    <% } %>
                                                                <% }); %>
                                                            </div>
                                                            

                                                            <!-- Order Items -->
                                                            <div class="order-items">
                                                                <% order.orderedItems.forEach(item => { %>
                                                                    <div class="item-row">
                                                                        <img src="/uploads/images/<%= item.product.productImage[0] %>"
                                                                             alt="Product" class="item-image">
                                                                        <div class="flex-grow-1">
                                                                            <h6 class="mb-1">
                                                                                <%= item.product.productName %>
                                                                            </h6>
                                                                            <p class="mb-0 text-muted">
                                                                                Quantity: <%= item.quantity %>
                                                                            </p>
                                                                        </div>
                                                                        <div class="text-end">
                                                                            <h6>â‚¹<%= (item.price * item.quantity).toFixed(2) %></h6>
                                                                            
                                                                            <% if (order.status === "Pending" || order.status === "Processing" || order.status ==='Partially Cancelled' ) { %>
                                                                                <% if (order.orderedItems.length > 1 && !order.coupon) { %>
                                                                                    <a class="text-danger" href="#" onclick="cancelOrderItem('<%= order.orderId %>', '<%= item.product._id %>')">Cancel Item</a>
                                                                                <% } %>
                                                                            <% } else if (order.status === "Delivered") { %>
                                                                                <% if (!item.returnDetails || item.returnDetails.status === 'Not Requested') { %>
                                                                                    <a class="text-danger" href="#" onclick="ReturnItem('<%= order.orderId %>', '<%= item.product._id %>')">Return Item</a>
                                                                                <% } else { %>
                                                                                    <span class="text-muted">Return already requested</span>
                                                                                <% } %>
                                                                            <% } %>
                                                                        </div>
                                                                    </div>
                                                                <% }) %>
                                                            
                                                                <% if (order.partialCancelledDetails.length > 0) { %>
                                                                    <h5 class="mt-4 text-warning">Partially Cancelled Items</h5>
                                                                    <% order.partialCancelledDetails.forEach(cancelled => { %>
                                                                        <div class="item-row">
                                                                            <img src="/uploads/images/<%= cancelled.product.productImage[0] %>"
                                                                                 alt="Product" class="item-image">
                                                                            <div class="flex-grow-1">
                                                                                <h6 class="mb-1">
                                                                                    <%= cancelled.product.productName %>
                                                                                </h6>
                                                                                <p class="mb-0 text-muted">
                                                                                    Original Quantity: <%= cancelled.originalQuantity %><br>
                                                                                    Cancelled Quantity: <%= cancelled.quantity %>
                                                                                </p>
                                                                            </div>
                                                                            <div class="text-end">
                                                                                <h6>Refund: â‚¹ <%= cancelled.refundAmount.toFixed(2) %></h6>
                                                                                <p class="text-muted">Cancelled On: <%= new Date(cancelled.cancelledOn).toLocaleDateString() %></p>
                                                                            </div>
                                                                        </div>
                                                                    <% }) %>
                                                                <% } %>
                                                                <br>
                                                                <div class="text-end">
                                                                    <h6>Total: â‚¹ <%= order.totalPrice.toFixed(2) %></h6>
                                                                </div><br>
                                                                <div class="text-end">
                                                                    <h6>Discount: - â‚¹ <%= order.discount.toFixed(2) %></h6>
                                                                </div><br>
                                                                <div class="text-end">
                                                                    <h6>Shipping Charge: + â‚¹ <%= parseFloat(order.shippingCharge || 0).toFixed(2) %></h6>
                                                                </div><br>
                                                                <div class="text-end">
                                                                    <h6 id="finalAmount">Final Price: â‚¹ <%= order.finalAmount.toFixed(2) %></h6>
                                                                </div>
                                                            
                                                                <% if (order.paymentDetails.paymentStatus === 'Failed') { %>
                                                                    <div id="timer" class="text-danger mt-3">
                                                                        <h5>"We noticed an issue with your payment. Donâ€™t worry, you have 1 day to resolve it. 
                                                                            If the payment isnâ€™t completed within this time, your order will be automatically canceled. 
                                                                            Please reach out to us if you need any assistance!"</h5>
                                                                    </div>
                                                                <% } %>
                                                            </div>
                                                            <!-- Address Information -->
                                                            <div class="row mt-4">
                                                                <!-- Shipping Address -->
                                                                <div class="col-md-4">
                                                                    <div class="address-card">
                                                                        <h6 class="mb-3">Shipping Address</h6>
                                                                        <span class="address-type"> <%= order.shippingAddress.addressType %></span>

                                                                        <div class="address-details"><div class="name"><%= user.name %> </div>

                                                                            <div class="location"><div><%= order.shippingAddress.name %> </div>
                                                                                <div><%= order.shippingAddress.landmark%></div>
                                                                                <div> <%= order.shippingAddress.city %></div>
                                                                                <div><%= order.shippingAddress.state %> -<%= order.shippingAddress.pincode %></div>
                                                                            </div>

                                                                            <div class="contact">
                                                                                <div
                                                                                    class="d-flex align-items-center mb-1">
                                                                                    <svg class="icon"
                                                                                        xmlns="http://www.w3.org/2000/svg"
                                                                                        fill="none" viewBox="0 0 24 24"
                                                                                        stroke="currentColor">
                                                                                        <path stroke-linecap="round"stroke-linejoin="round"stroke-width="2"d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                                                                    </svg>
                                                                                    <%= user.email %>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <!-- Order Notes -->
                                                                <div class="col-md-4">
                                                                    <h6>Order Notes</h6>
                                                                    <p class="mb-0"><%= order.notes || 'No special instructions.' %></p>
                                                                </div>

                                                            </div>

                                                            <% if (!['Cancelled', 'Delivered' ].includes(order.status)) {%>
                                                                <br>
                                                                <p>orderId: <%= order.orderId %></p>
                                                                <a class="btn btn-secondary btn-sm" href="#" onclick="cancelOrder('<%= order.orderId %>')">Cancel Order</a>
                                                                <% } %>
                                                                    <!-- Download Invoice Button -->
                                                                    <button class="btn btn-primary btn-sm"onclick="downloadInvoice('<%= order.orderId %>')">
                                                                        <i class="bi bi-file-earmark-arrow-down"></i>
                                                                        Download Invoice
                                                                    </button>

                                                                    <% if (order.paymentDetails && order.paymentDetails.paymentStatus==='Failed' ) { %>
                                                                        <button id="retryPaymentBtn" class="btn btn-warning btn-sm">Retry Payment
                                                                        </button>
                                                                     <% } %>
                                                        </div>
                                                        <% }); %>
                                                </div>
                                                <% } else { %>
                                                    <h3>NO orders</h3>
                                                        <% } %>
                                        </div>
                                    </div>
                                    <!-- Modal Structure -->
                                    <div class="modal fade" id="returnModal" tabindex="-1" aria-labelledby="returnModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content bg-light">
                                                <div class="modal-header bg-primary text-white">
                                                    <h5 class="modal-title" id="returnModalLabel">Return Request Processed</h5>
                                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p class="text-success">
                                                        <strong><i class="bi bi-check-circle-fill me-2"></i>Return Request Confirmed</strong>
                                                    </p>
                                                    <p>Dear Customer,</p>
                                                    <p>We have successfully processed your return request. Our delivery partner will contact you shortly to arrange a pickup at your convenience.</p>
                                                    
                                                    <div class="alert alert-warning" role="alert">
                                                        <h6 class="alert-heading">Important Return Instructions:</h6>
                                                        <ul class="mb-0">
                                                            <li>Ensure the item is securely packed for return.</li>
                                                            <li>Damaged or broken packets will not be accepted.</li>
                                                        </ul>
                                                    </div>
                                    
                                                    <p class="mt-3">Thank you for your understanding and cooperation. For any queries, feel free to contact our support team.</p>
                                                    <p class="text-muted">Best regards,<br>Henza's Dry Store</p>
                                                </div>
                                                <div class="modal-footer bg-light">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                    
                                <div class="tab-pane fade" id="address" role="tabpanel"
                                        aria-labelledby="address-tab">
                                        <div>
                                            <a href="/add-address">
                                                <button class="btn btn-primary">Add Address</button>
                                            </a>
                                        </div>
                                        <br><br>
                                        <div class="row">
                                            <% if(userAddress) {%>
                                                <% userAddress.address.forEach((address)=>{%>
                                                    <div class="col-lg-6">
                                                        <div class="card mb-3 mb-lg-0">
                                                            <div class="card-header">
                                                                <h3 class="mb-0">Address type:<%= address.addressType %>
                                                                </h3>
                                                            </div>
                                                            <div class="card-body ">
                                                                <address>Name:<%= address.name %><br>City: <%=
                                                                            address.city %><br>
                                                                            Landmark:<%= address.landmark %><br>State:
                                                                                <%= address.state %>
                                                                                    <br>Pincode :<%= address.pincode %>
                                                                                        <br>Phone:<%= address.phone %>
                                                                                            <br>
                                                                                            Alternative Phone:<%=
                                                                                                address.altPhone %>
                                                                </address><br>

                                                                <a class="btn btn-primary btn-sm"
                                                                    href="/edit-address/?id=<%= address._id %>">Edit</a>
                                                                <a class="btn btn-secondary btn-sm" href="#"
                                                                    onclick="confirmDelete('<%= address._id %>')">Delete</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <% }) %>
                                                        <% }else {%>
                                                            <div class="col-lg-6">
                                                                <div class="card">
                                                                    <div class="card-header">
                                                                        <h5 class="mb-0">NO Address</h5>
                                                                    </div>

                                                                </div>
                                                            </div>
                                                            <% } %>
                                        </div>
                                </div>
                                <div class="tab-pane fade" id="account-detail" role="tabpanel"
                                        aria-labelledby="account-detail-tab">
                                        <div class="container">
                                            <div class="row">
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div class="header-action-icon-2 text-center">
                                                            <a href="#" class="d-block">
                                                                <img class="svgInject mb-2" alt="Super Coins"
                                                                    src="/uploads/sample-images/coin-stack.png"
                                                                    style="width: 30px; height: 30px;">
                                                            </a>
                                                            <h6 class="text-muted">Super Coins</h6>
                                                            <span class="badge bg-primary">
                                                                <%= rewardPoints %>
                                                            </span>
                                                        </div>

                                                        <div class="header-action-icon-2 text-center">
                                                            <a href="/wallet" class="d-block">
                                                                <img class="svgInject mb-2" alt="Wallet"
                                                                    src="/uploads/sample-images/wallet (1).png"
                                                                    style="width: 30px; height: 30px;">
                                                            </a>
                                                            <h6 class="text-muted">Wallet Balance</h6>
                                                            <span class="badge bg-success">â‚¹ <%=
                                                                    walletBalance.toFixed(2) %></span>
                                                        </div>

                                                        <div class="header-action-icon-2 text-center">
                                                            <a href="/wishlist" class="d-block">
                                                                <img class="svgInject mb-2" alt="Wishlist"
                                                                    src="/uploads/sample-images/folder.png"
                                                                    style="width: 30px; height: 30px;">
                                                            </a>
                                                            <h6 class="text-muted">Wishlist</h6>
                                                            <span class="badge bg-info">
                                                                <%= wishlistCount %>
                                                            </span>
                                                        </div>

                                                        <div class="header-action-icon-2 text-center">
                                                            <a href="/cart" class="d-block">
                                                                <img class="svgInject mb-2" alt="Cart"
                                                                    src="/uploads/sample-images/procurement.png"
                                                                    style="width: 30px; height: 30px;">
                                                            </a>
                                                            <h6 class="text-muted">Cart</h6>
                                                            <span class="badge bg-warning">
                                                                <%= cartCount %>
                                                            </span>
                                                        </div>
                                                        <div class="header-action-icon-2 text-center">
                                                            <a href="/cart" class="d-block">
                                                                <img class="svgInject mb-2" alt="Cart"
                                                                    src="/uploads/sample-images/employee.png"
                                                                    style="width: 30px; height: 30px;">
                                                            </a>
                                                            <h6 class="text-muted">Referal Code</h6>
                                                            <span class="badge bg-primary">
                                                                <%= user.referralCode %>
                                                            </span> 
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                </div>
                            </div>
                        </div>
                     </div>
                 </div>
            </div>
        </div>
    </section>
</main>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 100" style="display:none;">
  <!-- Order Placed Icon -->
  <symbol id="icon-order-placed" viewBox="0 0 50 50">
    <rect x="10" y="15" width="30" height="25" fill="none" stroke="currentColor" stroke-width="2"/>
    <path d="M15 25h20M15 32h20" stroke="currentColor" stroke-width="2"/>
    <path d="M20 15v-5h10v5" fill="none" stroke="currentColor" stroke-width="2"/>
  </symbol>
  
  <!-- Packaging Icon -->
  <symbol id="icon-packaging" viewBox="0 0 50 50">
    <path d="M10 35l15-10 15 10-15 10z" fill="none" stroke="currentColor" stroke-width="2"/>
    <path d="M25 25v-15M10 35v-15l15-10 15 10v15" fill="none" stroke="currentColor" stroke-width="2"/>
  </symbol>
  
  <!-- On The Road Icon -->
  <symbol id="icon-on-road" viewBox="0 0 50 50">
    <rect x="5" y="25" width="30" height="15" fill="none" stroke="currentColor" stroke-width="2"/>
    <circle cx="12" cy="40" r="5" fill="none" stroke="currentColor" stroke-width="2"/>
    <circle cx="28" cy="40" r="5" fill="none" stroke="currentColor" stroke-width="2"/>
    <path d="M35 30h8l2 5v5h-5" fill="none" stroke="currentColor" stroke-width="2"/>
  </symbol>
  
  <!-- Delivered Icon -->
  <symbol id="icon-delivered" viewBox="0 0 50 50">
    <circle cx="25" cy="25" r="15" fill="none" stroke="currentColor" stroke-width="2"/>
    <path d="M17 25l6 6 10-12" fill="none" stroke="currentColor" stroke-width="2"/>
  </symbol>
</svg>

    <script>
        function confirmDelete(addressId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "Do you really want to delete this address? This action cannot be undone.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/delete-address?id=${addressId}`, {
                        method: 'DELETE',
                    })
                        .then(response => {
                            if (response.ok) {
                                Swal.fire({

                                    title: 'Deleted!',
                                    text: "The address has been deleted.",
                                    icon: "success",
                                    position: 'center',
                                    toast: true,
                                }

                                ).then(() => {

                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    title: "Error",
                                    text: "Failed to delete the address. Please try again later.",
                                    icon: "error",
                                    position: 'center',
                                    toast: true,
                                })
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting address:', error);
                            Swal.fire({
                                title: "Error",
                                text: "An unexpected error occurred.",
                                icon: "error",
                                position: 'center',
                                toast: true,
                            })
                        });
                }
            });
        }
    </script>
    <script>
        function cancelOrder(orderId) {
            console.log('Cancelling order:', orderId);
            fetch(`/check-order-payment?orderId=${orderId}`)
                .then(response => response.json())
                .then(orderData => {
                    if (orderData.isOnlinePayment) {
                        Swal.fire({
                            title:  'Are you sure?',
                            text: "How would you like to receive your refund?",
                            icon: "question",
                            showCancelButton: true,
                            showDenyButton: true,
                            confirmButtonColor: '#3085d6',
                            denyButtonColor: '#17a2b8',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Refund to Wallet',
                            denyButtonText: 'Refund to Bank',
                            cancelButtonText: 'Cancel',
                            tost: true,
                            position: "center"

                        }).then((result) => {
                            if (result.isConfirmed || result.isDenied) {
                                const refundMethod = result.isConfirmed ? 'WALLET' : 'BANK';
                                processCancellation(orderId, refundMethod)
                            }
                        })
                    } else {
                        Swal.fire({
                            title: 'Are you sure?',
                            text: "Do you really want to cancel this order?",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Yes, cancel it!',
                            cancelButtonText: 'No, keep it',
                            tost: true,
                            position: "center"

                        }).then((result) => {
                            if (result.isConfirmed) {
                                processCancellation(orderId, null);
                            }
                        });
                    }
                }).catch(error => {
                    console.error('Error checking order payment:', error);
                    showError("Failed to process request");
                });

        }
        function processCancellation(orderId, refundMethod) {
            const url = refundMethod
                ? `/cancel-order?orderId=${orderId}&refundMethod=${refundMethod} `
                : `/cancel-order?orderId=${orderId}`;
            fetch(url).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: 'Cancelled!',
                            text: data.message,
                            icon: 'success',
                            position: 'center',
                            toast: true,
                        }).then(() => {
                            window.location.href = data.redirectUrl;
                        });
                    } else {
                        showError(data.message);
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    showError('Failed to cancel order');
                })
        };
        function showError(message) {
            Swal.fire({
                title: "Error",
                text: message,
                icon: "error",
                position: 'center',
                toast: true,
            })
        };
    </script>
    <script>
        let currentOrderIndex = 0;
        const totalOrders = '<%= userOrders ? userOrders.length : 0 %>';

        function navigateOrders(direction) {

            const currentOrder = document.querySelector(`[data-order-index="${currentOrderIndex}"]`);
            currentOrder.style.opacity = '0';

            setTimeout(() => {
                currentOrder.style.display = 'none';

                if (direction === 'next' && currentOrderIndex < totalOrders - 1) {
                    currentOrderIndex++;
                } else if (direction === 'prev' && currentOrderIndex > 0) {
                    currentOrderIndex--;
                }
                const nextOrder = document.querySelector(`[data-order-index="${currentOrderIndex}"]`);
                nextOrder.style.display = 'block';
                setTimeout(() => {
                    nextOrder.style.opacity = '1';
                }, 50);
                updateNavigationState();
            }, 300);
        }

        function updateNavigationState() {
            document.getElementById('prevBtn').disabled = currentOrderIndex === 0;
            document.getElementById('nextBtn').disabled = currentOrderIndex === totalOrders - 1;
        }

        // Initialize navigation on page load
        document.addEventListener('DOMContentLoaded', function () {
            updateNavigationState();
            const firstOrder = document.querySelector('[data-order-index="0"]');
            if (firstOrder) {
                firstOrder.style.display = 'block';
                firstOrder.style.opacity = '1';
            }
        });
    </script>
    <script>
        function cancelOrderItem(orderId, productId) {
            console.log('Partially cancelling order item:', orderId, productId);

            fetch(`/check-order-payment?orderId=${orderId}`)
                .then(response => response.json())
                .then(orderData => {
                    if (orderData.isOnlinePayment||orderData.isWallet) {
                        Swal.fire({
                            title: 'Are you sure?',
                            text: "How would you like to receive your refund?",
                            icon: "question",
                            showCancelButton: true,
                            showDenyButton: true,
                            confirmButtonColor: '#3085d6',
                            denyButtonColor: '#17a2b8',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Refund to Wallet',
                            denyButtonText: 'Refund to Bank',
                            cancelButtonText: 'Cancel',
                            tost: true,
                            position: "center",
                            background: 'purple',
                            color:"gold",

                        }).then((result) => {
                            if (result.isConfirmed || result.isDenied) {
                                const refundMethod = result.isConfirmed ? 'WALLET' : 'BANK';
                                processPartialCancellation(orderId, productId, refundMethod);
                            }
                        });
                    } else {
                        Swal.fire({
                            title: 'Are you sure?',
                            text: "Do you really want to cancel this item?",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Yes, cancel it!',
                            cancelButtonText: 'No, keep it',
                            tost: true,
                            position: "center",
                            background: 'purple',
                            color:"gold",

                        }).then((result) => {
                            if (result.isConfirmed) {
                                processPartialCancellation(orderId, productId, null);
                            }
                        });
                    }
                }).catch(error => {
                    console.error('Error checking order payment:', error);
                    showError("Failed to process request");
                });
        }

        function processPartialCancellation(orderId, productId, refundMethod) {
            const url = refundMethod
                ? `/cancel-order-item?orderId=${orderId}&productId=${productId}&refundMethod=${refundMethod}`
                : `/cancel-order-item?orderId=${orderId}&productId=${productId}`;

            fetch(url, {
                method: 'PATCH'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: 'Partially Cancelled!',
                            text: data.message,
                            icon: 'success',
                            position: 'top-end',
                            toast: true,
                            timer: 3000,
                            showConfirmButton: false,
                            background: 'purple',
                            color:"gold",
                        }).then(() => {
                            const itemElement = document.getElementById(`product-${productId}`);
                            if (itemElement) {
                                itemElement.style.filter = 'blur(5px)';
                                itemElement.style.opacity = '0.6';
                                itemElement.innerHTML += '<span class="status-label">Partially Cancelled</span>';
                            }
                            window.location.href = data.redirectUrl;
                        });
                    } else {
                        showError(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('Failed to cancel order item');
                });
        }

        function showError(message) {
            Swal.fire({
               
                text: message,
                icon: "error",
                position: "top-end",
                toast: true,
                background: 'purple',
                color:"gold",
            });
        }
    </script>
    <script>
        function downloadInvoice(orderId) {
            fetch('/download-invoice', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ orderId })
            }).then(response => {
                if (!response.ok) {
                    throw new Error(`Response from network is not ok Status: ${response.status}`);
                }
                return response.blob();
            }).then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `invoice-${orderId}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);


            }).catch(error => {
                console.error('An error occured for download invoice');
                Swal.fire({
                    icon: "error",
                    text: "Failed to download invoice. Please try again later.",
                    toast: true,
                    position: "top-end",
                    background: 'purple',
                     color:"gold"

                })
            })

        }
    </script>
    <script>
        document.getElementById('retryPaymentBtn').addEventListener('click', async function () {
            try {
                const paymentOption = "ONLINE";
                const amountText = document.getElementById('finalAmount').innerText.replace(/[^\d.]/g, '');
                const amount = Math.round(parseFloat(amountText));
                const orderId= document.getElementById('orderId').textContent.trim();
    
                const response = await fetch('/create-razorpay-order', {
                    method: "POST",
                    headers: { 'content-type': 'application/json' },
                    body: JSON.stringify({ amount, paymentOption })
                });

                const data = await response.json();
                console.log('Response from server:', data);

                if (!data.success) {
                    throw new Error(data.error || "Failed to create Razorpay order for retry");
                }


                const options = {
                    key: data.key,
                    amount: data.amount,
                    currency: data.currency,
                    name: "Henza's Dry Store",
                    description: 'Retry Payment For Order',
                    order_id: data.order_id,
                    
                    handler: async function (response) {
                        try {
                            const verifyResponse = await fetch('/verify-repay-payment', {
                                method: "PATCH",
                                headers: { 'content-type': 'application/json' },
                                body: JSON.stringify({
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_order_id: response.razorpay_order_id,
                                    razorpay_signature: response.razorpay_signature,
                                    orderId,
                                    amount,
                                    
                                })
                            });

                            const verifyResult = await verifyResponse.json();

                            if (verifyResult.success) {
                                Swal.fire({
                                    title: "Payment Success",
                                    text: "Your retry payment has been processed successfully.",
                                    icon: "success",
                                    position: 'center',
                                    toast: true,
                                }).then(() => {
                                    window.location.reload();
                                });
                            } else {
                                throw new Error("Retry payment verification failed");
                            }
                        } catch (error) {
                            Swal.fire({
                                title: "Payment Failed",
                                text: "Retry payment verification failed. Please try again",
                                icon: "error",
                                position: 'center',
                                toast: true,
                            });
                        }
                    },
                    prefill: {
                        name: data.prefill.name,
                        email: data.prefill.email,
                        contact: data.prefill.contact,
                    },
                    theme: {
                        color: "#3399cc"
                    },
                    modal: {
                        ondismiss: async function () {
                            Swal.fire({
                                title: "Payment Incomplete",
                                text: "You canceled the retry payment.",
                                icon: "warning",
                                position: 'center',
                                toast: true,
                            });
                        }
                    }
                };

                const razorpayInstance = new Razorpay(options);
                razorpayInstance.open();
            } catch (error) {
                console.error('Razorpay Retry Initialization Error', error);
                Swal.fire({
                    title: "Error",
                    text: error.message || "Failed to initialize retry payment. Please try again",
                    position: 'center',
                    toast: true,
                    icon: "error"
                });
            }
        });
    </script>
    <script>
        async function ReturnItem(orderId, productId) {
            try {
                const response = await fetch('/returnProduct', {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: orderId, productId: productId })
                });
                const data = await response.json()
                if (data.success) {
                    const modal = new bootstrap.Modal(document.getElementById('returnModal'));
                    modal.show()
                    document.getElementById('returnModal').addEventListener('hidden.bs.modal', function () {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: "error",
                        text: data.message || "Failed to return item",
                        toast: true,
                        position: "top-end",
                        background: 'purple',
                            color:"gold"
                    })
                }
            } catch (error) {
                console.error(' Error returning  item', error);
                Swal.fire({
                    icon: "error",
                    text: 'An error occurred while processing  your return',
                    toast: true,
                    position: "top-end",
                    background: 'purple',
                    color:"gold"
                })
            }
        }
    </script>


    <%- include('../partials/user/footer.ejs') %>