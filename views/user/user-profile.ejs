
<%- include('../partials/user/header.ejs') %>
<style>
    body {
        background-color: #ffe2f2;
        min-height: 100vh;
        padding: 2rem 0;
    }
    .order-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        max-width: 800px;
        margin: 0 auto;
    }
    .progress-tracker {
        position: relative;
        margin: 30px 0;
    }

    .progress-line {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background: #f3ebeb;
        transform: translateY(-50%);
    }

    .progress-steps {
        position: relative;
        display: flex;
        justify-content: space-between;
    }   
    .step {
        position: relative;
        width: 25px;
        height: 25px;
        background: #fff;
        border: 2px solid #e9ecef;
        border-radius: 50%;
        z-index: 1;
    }
    .step.placed {
  background-color: rgb(158, 230, 95);
}

.step.packaging {
  background-color: rgb(225, 180, 0);
  color: white; 
}

.step.ontheRoad {
  background-color: rgb(60, 90, 237);
}

.step.orderDelivered {
  background-color: green;
  color: white;
}
    .step.active {
        border-color: #28a745;
        background: #8fd8a0;
    }
    .step.cancelled {
        border-color: #dc3545;
        background: #dc3545;
    }

    .step-label {
        position: absolute;
        top: 30px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-size: 12px;
        color: #5d0451;
    }
    .activity-feed {
        margin: 2rem 0;
    }
    .activity-item {
        display: flex;
        align-items: start;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
    }

    .activity-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-right: 15px;
    }
    .activity-icon.text-danger {
        background-color: rgba(220, 53, 69, 0.1);
    }
    .order-items {
        margin: 2rem 0;
    }
    .item-row {
        display: flex;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid #dee2e6;
    }
    .item-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        margin-right: 1rem;
        border-radius: 8px;
    }
    .address-card {
            padding: 1.5rem;
            border-radius: 12px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(79, 10, 39, 0.1);
            border: 1px solid rgba(79, 10, 39, 0.1);
        }

        .address-type {
            display: inline-block;
            padding: 4px 12px;
            background-color: #5d0451;
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }

        .address-details {
            color: #5d0451;
            line-height: 1.6;
        }

        .address-details .name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .address-details .location {
            margin-bottom: 1rem;
        }

        .address-details .contact {
            padding-top: 0.5rem;
            border-top: 1px dashed rgba(79, 10, 39, 0.2);
            font-size: 0.9rem;
        }

        .icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            opacity: 0.7;
        }
</style>


<main class="main">
    <div class="page-header breadcrumb-wrap">
        <div class="container">
            <div class="breadcrumb">
                <a href="index.html" rel="nofollow">Home</a>
                <span></span> Pages
                <span></span> Account
            </div>
        </div>
    </div>
    <section class="pt-150 pb-150">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 m-auto">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="dashboard-menu">
                                <ul class="nav flex-column" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false"><i class="fi-rs-settings-sliders mr-10"></i>Dashboard</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false"><i class="fi-rs-shopping-bag mr-10"></i>Orders</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#track-orders" role="tab" aria-controls="track-orders" aria-selected="false"><i class="fi-rs-shopping-cart-check mr-10"></i>Track Your Order</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="true"><i class="fi-rs-marker mr-10"></i>My Address</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="account-detail-tab" data-bs-toggle="tab" href="#account-detail" role="tab" aria-controls="account-detail" aria-selected="true"><i class="fi-rs-user mr-10"></i>Account details</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="logOut"><i class="fi-rs-sign-out mr-10"></i>Logout</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="tab-content dashboard-content">
                                <div class="tab-pane fade active show" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                                    <div class="container mt-5 p-4 border rounded shadow-sm bg-light" style="max-width: 400px;">
                                        <div class="row mb-3">
                                            <label class="col-sm-4 fw-bold">User Name:</label>
                                            <div class="col-sm-8"><%= user.name %></div>
                                        </div>
                                        <div class="row mb-3">
                                            <label class="col-sm-4 fw-bold">Phone Number:</label>
                                            <div class="col-sm-8"><%= user.phone %></div>
                                        </div>
                                        <div class="row">
                                            <label class="col-sm-4 fw-bold">Email:</label>
                                            <div class="col-sm-8"><%= user.email %></div>
                                        </div>
                                        <div class="d-flex justify-content-around mt-4">
                                           <a href="/change-email"class="btn btn-primary btn-sm">Change Email</a>
                                            <a href="/change-password"class="btn btn-secondary btn-sm">Change Password</a>
                                        </div>
                                </div>
                                </div>
                                <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                                    <div class="container">
                                        <% if(userOrders && userOrders.length > 0) {%>

                                            <% userOrders.forEach(order=>  {%>
                                        <div class="order-card">                                            
                                            <!-- Header -->

                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h5 class="mb-1"><%= order.orderId %></h5>
                                                    <p class="text-muted small"><%= order.orderedItems.length %> â€¢ Order Placed on <%= order.createdOn.toLocaleDateString() %></p>
                                                </div>
                                                <div>
                                                    <h5><%= order.finalAmount.toFixed(2) %></h5>
                                                </div>
                                            </div>
                                
                                            <!-- Progress Tracker -->
                                            <div class="progress-tracker">
                                                <div class="progress-line"></div>
                                                <div class="progress-steps">
                                                    <% if (order.status === 'Cancelled') { %>
                                                        <!-- Show only cancelled status when order is cancelled -->
                                                        <div class="step active " >
                                                            <span class="step-label text-success">Order Placed</span>
                                                        </div>
                                                        <div class="step active cancelled"  >
                                                            <span class="step-label text-danger" >Cancelled</span>
                                                        </div>
                                                    <% } else { %>
                                                        <!-- Show normal progress steps for active orders -->
                                                        <div class="step <%= order.status === 'Pending' || order.status === 'Processing' || order.status === 'Shipped' || order.status === 'Delivered' ? 'placed' : '' %>"  >
                                                            <span class="step-label">Order Placed</span>
                                                        </div>
                                                        <div class="step <%= order.status === 'Processing' || order.status === 'Shipped' || order.status === 'Delivered' ? 'packaging' : '' %>">
                                                            <span class="step-label">Packaging</span>
                                                        </div>
                                                        <div class="step <%= order.status === 'Shipped' || order.status === 'Delivered' ? 'ontheRoad' : '' %>">
                                                            <span class="step-label">On The Road</span>
                                                        </div>
                                                        <div class="step <%= order.status === 'Delivered' ? 'orderDelivered' : '' %>">
                                                            <span class="step-label">Delivered</span>
                                                        </div>
                                                    <% } %>
                                                </div>
                                            </div>
                                
                                             <!-- Activity Feed -->
                                             <div class="activity-feed">
                                                <h6 class="mb-3">Order Activity</h6>
                                                <% if (order.status === 'Delivered') { %>
                                                    <div class="activity-item bg-light">
                                                        <div class="activity-icon text-success">âœ“</div>
                                                        <div>
                                                            <p class="mb-0">Your order has been delivered. Thank you for shopping!</p>
                                                            <small class="text-muted"><%= new Date(order.invoiceDate).toLocaleString() %></small>
                                                        </div>
                                                    </div>
                                                <% } else if (order.status === 'Cancelled') { %>
                                                    <div class="activity-item bg-light">
                                                        <div class="activity-icon text-danger">âœ•</div>
                                                        <div>
                                                            <p class="mb-0">Your order has been cancelled.</p>
                                                            <small class="text-muted"><%= new Date(order.createdOn).toLocaleString() %></small>
                                                        </div>
                                                    </div>
                                                <% } %>
                                            </div>
                                
                                             <!-- Order Items -->
                                             <div class="order-items">
                                                 <% order.orderedItems.forEach(item=> {%>
                                                <div class="item-row">
                                                    <img src="/uploads/images/<%= item.product.productImage[0] %>" alt="Product" class="item-image">
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-1"><%= item.product.productName %></h6>
                                                        <p class="mb-0 text-muted"><%= item.quantity %></p>
                                                    </div>
                                                    <div class="text-end">
                                                        <h6>â‚¹<%= item.price.toFixed(2) %></h6>
                                                    </div>
                                                </div>

                                                 <% }) %>
                                            </div>
                                            
                                
                                            <!-- Address Information -->
                                            <div class="row mt-4">
                                               
                                            
                                                <!-- Shipping Address -->
                                                <div class="col-md-4">
                                                    <div class="address-card">
                                                        <h6 class="mb-3">Shipping Address</h6>
                                                        <span class="address-type">
                                                            <%= order.shippingAddress.addressType %>
                                                        </span>
                                                        
                                                        <div class="address-details">
                                                            <div class="name">
                                                                <%= user.name %>
                                                            </div>
                                                            
                                                            <div class="location">
                                                                <div><%= order.shippingAddress.name %></div>
                                                                <div><%= order.shippingAddress.landmark %></div>
                                                                <div><%= order.shippingAddress.city %></div>
                                                                <div><%= order.shippingAddress.state %> - <%= order.shippingAddress.pincode %></div>
                                                            </div>
                                                            
                                                            <div class="contact">
                                                                <div class="d-flex align-items-center mb-1">
                                                                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                                                    </svg>
                                                                    <%= user.email %>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            
                                                <!-- Order Notes -->
                                                <div class="col-md-4">
                                                    <h6>Order Notes</h6>
                                                    <p class="mb-0">
                                                        <%= order.notes || 'No special instructions.' %>
                                                    </p>
                                                </div>
                                               
                                            </div>
                                            <% if (!['Cancelled', 'Delivered',].includes(order.status)) { %>
                                                <br>
                                                <p>orderId: <%= order.orderId %></p>
                                                <a class="btn btn-secondary btn-sm" href="#" onclick="cancelOrder('<%= order.orderId %>')">Cancel Order</a>
                                            <% } %>
                                        </div>
                                        <br>
                                        <% }) %>
                                        <% }else {%>
                                            <h3>NO orders</h3>
                                            <% } %>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="track-orders-tab">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Orders tracking</h5>
                                        </div>
                                        <div class="card-body contact-from-area">
                                            <p>To track your order please enter your OrderID in the box below and press "Track" button.
                                                 This was given to you on your receipt and in the confirmation email you should have received.</p>
                                            <div class="row">
                                                <div class="col-lg-8">
                                                    <form class="contact-form-style mt-30 mb-50" action="#" method="post">
                                                        <div class="input-style mb-20">
                                                            <label>Order ID</label>
                                                            <input name="order-id" placeholder="Found in your order confirmation email" type="text" class="square">
                                                        </div>
                                                        <div class="input-style mb-20">
                                                            <label>Billing email</label>
                                                            <input name="billing-email" placeholder="Email you used during checkout" type="email" class="square">
                                                        </div>
                                                        <button class="submit submit-auto-width" type="submit">Track</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                                    <div>
                                        <a href="/add-address">
                                            <button class="btn btn-primary">Add Address</button>
                                        </a>
                                    </div>
                                    <br><br>
                                    <div class="row">
                                        <% if(userAddress) {%>
                                            <% userAddress.address.forEach((address)=>{%>
                                        <div class="col-lg-6">
                                            <div class="card mb-3 mb-lg-0">
                                                <div class="card-header">
                                                    <h3 class="mb-0">Address type:<%= address.addressType %></h3>
                                                </div>
                                                <div class="card-body ">
                                                    <address >Name:<%= address.name %><br>City: <%= address.city %><br>
                                                        Landmark:<%= address.landmark %><br>State:<%= address.state %>
                                                        <br>Pincode :<%= address.pincode %> <br>Phone:<%= address.phone %> <br>
                                                         Alternative Phone:<%= address.altPhone %></address><br>
                                                    
                                                    <a class="btn btn-primary btn-sm" href="/edit-address/?id=<%= address._id %>" >Edit</a>
                                                    <a class="btn btn-secondary btn-sm" href="#" 
                                                    onclick="confirmDelete('<%= address._id %>')">Delete</a>
                                                </div>
                                            </div>
                                        </div>
                                        <% }) %>
                                        <% }else {%>
                                        <div class="col-lg-6">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="mb-0">NO Address</h5>
                                                </div>
                                            
                                            </div>
                                        </div>
                                        <% } %>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="account-detail" role="tabpanel" aria-labelledby="account-detail-tab">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>Account Details</h5>
                                        </div>
                                        <div class="card-body">
                                            <p>Already have an account? <a href="page-login-register.html">Log in instead!</a></p>
                                            <form method="post" name="enq">
                                                <div class="row">
                                                    <div class="form-group col-md-6">
                                                        <label>First Name <span class="required">*</span></label>
                                                        <input required="" class="form-control square" name="name" type="text">
                                                    </div>
                                                    <div class="form-group col-md-6">
                                                        <label>Last Name <span class="required">*</span></label>
                                                        <input required="" class="form-control square" name="phone">
                                                    </div>
                                                    <div class="form-group col-md-12">
                                                        <label>Display Name <span class="required">*</span></label>
                                                        <input required="" class="form-control square" name="dname" type="text">
                                                    </div>
                                                    <div class="form-group col-md-12">
                                                        <label>Email Address <span class="required">*</span></label>
                                                        <input required="" class="form-control square" name="email" type="email">
                                                    </div>
                                                    <div class="form-group col-md-12">
                                                        <label>Current Password <span class="required">*</span></label>
                                                        <input required="" class="form-control square" name="password" type="password">
                                                    </div>
                                                    <div class="form-group col-md-12">
                                                        <label>New Password <span class="required">*</span></label>
                                                        <input required="" class="form-control square" name="npassword" type="password">
                                                    </div>
                                                    <div class="form-group col-md-12">
                                                        <label>Confirm Password <span class="required">*</span></label>
                                                        <input required="" class="form-control square" name="cpassword" type="password">
                                                    </div>
                                                    <div class="col-md-12">
                                                        <button type="submit" class="btn btn-fill-out submit" name="submit" value="Submit">Save</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<script>
    function confirmDelete(addressId) {
        console.log('Cancelling order:', orderId);
        Swal.fire({
            title: 'Are you sure?',
            text: "Do you really want to delete this address? This action cannot be undone.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                console.log(`Redirecting to: /cancel-order?orderId=${orderId}`);
                window.location.href = `delete-address?id=${addressId}`;
            }
        });
    }
</script>
<script>
    function cancelOrder(orderId) {
    console.log('Cancelling order:', orderId);
    Swal.fire({
        title: 'Are you sure?',
        text: "Do you really want to cancel this order?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, cancel it!',
        cancelButtonText: 'No, keep it'
    }).then((result) => {
        if (result.isConfirmed) {
            
            fetch(`/cancel-order?orderId=${orderId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire(
                            'Cancelled!',
                            data.message,
                            'success'
                        ).then(() => {
                            window.location.href = data.redirectUrl;
                        });
                    } else {
                        Swal.fire(
                            'Error!',
                            data.message,
                            'error'
                        );
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire(
                        'Error!',
                        'Failed to cancel order',
                        'error'
                    );
                });
        }
    });
}
</script>
<%- include('../partials/user/footer.ejs') %>